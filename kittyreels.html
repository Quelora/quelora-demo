<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KittyReels</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./quelora/css/quelora.css">
    <style>
        /* CSS Variables for Theming */
        :root {
            --bg-color: #f8f9fa;
            --text-color: #202124;
            --header-bg: rgba(255, 255, 255, 0.85);
            --card-bg: #e8eaed;
            --card-shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
            --card-hover-shadow: 0 4px 8px 3px rgba(60,64,67,0.15), 0 1px 3px 0 rgba(60,64,67,0.3);
            --modal-bg: rgba(0,0,0,0.85);
            --control-bg: rgba(32,33,36,0.7);
            --control-hover-bg: rgba(32,33,36,0.9);
            --header-border: #dadce0;
        }

        [data-theme="dark"] {
            --bg-color: #121212;
            --text-color: #e8eaed;
            --header-bg: rgba(24, 24, 24, 0.85);
            --card-bg: #2a2a2a;
            --card-shadow: 0 2px 4px rgba(0,0,0,0.4);
            --card-hover-shadow: 0 6px 12px rgba(0,0,0,0.4);
            --modal-bg: rgba(0,0,0,0.9);
            --control-bg: rgba(40,40,40,0.7);
            --control-hover-bg: rgba(40,40,40,0.9);
            --header-border: #3c4043;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s;
        }

        /* Header */
        header {
            background-color: var(--header-bg);
            border-bottom: 1px solid var(--header-border);
            padding: 12px 0;
            position: sticky;
            top: 0;
            z-index: 10;
            width: 100%;
            backdrop-filter: blur(8px);
            transition: box-shadow 0.3s ease;
        }
        
        header.scrolled {
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .header-container {
            max-width: 975px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 24px;
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        /* Theme Toggle */
        .theme-switch {
            background: var(--control-bg);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: background-color 0.2s, transform 0.2s;
        }
        .theme-switch:hover {
            background: var(--control-hover-bg);
            transform: scale(1.1);
        }

        /* Main Content */
        main {
            max-width: 975px;
            margin: 0 auto;
            padding: 32px 24px;
        }

        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 28px;
        }

        @media (max-width: 600px) {
            .video-grid {
                grid-template-columns: 1fr;
                gap: 24px;
            }
            main {
                padding: 24px 16px;
            }
        }

        /* Video Item */
        .video-item {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--card-shadow);
            background-color: var(--card-bg);
            aspect-ratio: 9/16;
            transition: transform 0.25s cubic-bezier(0.4, 0.0, 0.2, 1), box-shadow 0.25s cubic-bezier(0.4, 0.0, 0.2, 1);
            cursor: pointer;
        }
        .video-item:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: var(--card-hover-shadow);
        }

        .video-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .video-item .poster {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            object-fit: cover;
            z-index: 1;
            transition: opacity 0.3s ease;
        }

        /* In-place Fullscreen (Mobile) */
        .fullscreen-controls {
            position: absolute;
            top: 12px;
            left: 0; right: 0;
            padding: 12px;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            z-index: 3;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .video-item.playing-full .fullscreen-controls { opacity: 1; }

        .fs-button {
            background: var(--control-bg);
            border: none;
            color: #fff;
            font-size: 20px;
            width: 40px; height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }
        .fs-button:hover { background: var(--control-hover-bg); }

        .sound-toggle {
            position: absolute;
            bottom: 12px; right: 12px;
            background: var(--control-bg);
            border-radius: 50%;
            width: 40px; height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 4;
            border: none;
            transition: background-color 0.2s;
            color: #fff;
            font-size: 18px;
        }
        .sound-toggle:hover { background: var(--control-hover-bg); }

        .play-pause-overlay {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            z-index: 3;
            background-color: rgba(0,0,0,0.2);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }
        .play-pause-overlay svg {
            width: 64px; height: 64px;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
        }
        .video-item.is-paused .play-pause-overlay { opacity: 1; }
        
        /* --- CSS CORREGIDO --- */
        .video-actions-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 16px;
            /* background: linear-gradient(to top, rgba(0, 0, 0, 0.7) 10%, transparent 90%); */
            z-index: 3;
            opacity: 1; /* Siempre visible */
            pointer-events: all; /* Siempre permite interacci√≥n */
        }

        .action-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            transition: transform 0.2s ease;
            padding: 4px;
            text-shadow: 0 1px 4px rgba(0,0,0,0.6); /* Sombra para contraste */
        }

        .action-btn:hover {
            transform: scale(1.15);
        }

        .action-bookmark {
            margin-left: auto;
        }

        /* Video Modal (Desktop) */
        .video-modal {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: var(--modal-bg);
            display: flex; justify-content: center; align-items: center;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s cubic-bezier(0.4, 0.0, 0.2, 1);
        }
        .video-modal.active { opacity: 1; pointer-events: all; }

        .video-modal-content {
            position: relative;
            max-width: 90%;
            max-height: 90vh;
            width: auto;
            height: auto;
        }
        .video-modal-content video {
            max-width: 100%;
            max-height: 90vh;
            display: block;
            border-radius: 8px;
        }
        .close-modal {
            position: absolute; top: -45px; right: -5px;
            color: #fff;
            font-size: 40px;
            font-weight: 300;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .close-modal:hover { transform: scale(1.1); }

        /* Loading Indicators */
        .loading-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 32px;
            gap: 10px;
            font-size: 15px;
            color: var(--text-color);
        }
        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(128, 128, 128, 0.3);
            border-top-color: var(--text-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .video-loading {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2;
            display: none;
        }
        .video-item.loading .video-loading { display: block; }
        
        .preload-container { display: none; }

        .community-interaction-bar .interaction-actions .interaction-item .interaction-icon.active svg, 
        .community-threads .comment-header .comment-like .quelora-icons-outlined.active svg {
            color: var(--quelora-active-icon-color)!important;
        }

        .community-interaction-bar svg,
        .community-interaction-bar .interaction-count{
            color: #fff !important;
        }

        .community-interaction-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0px!important;
            margin: 0px!important;
            flex-direction: column;
            position: relative;
            left: 94%!important;
            padding-bottom: 60px!important;
            scale: 1.25;
        }

        .community-interaction-bar .interaction-actions {
            display: flex;
            align-items: center;
            flex-direction: column!important;
        }

        .community-interaction-bar .interaction-actions .interaction-item{
            flex-direction: column!important;
            margin: 0px!important;
        }
        .community-interaction-bar .interaction-actions .interaction-item .interaction-count{
            position: relative;
            left: -2px;
        }


    </style>
</head>
<body>
    <header id="pageHeader">
        <div class="header-container">
            <div class="logo">üê± KittyReels</div>
            <button class="theme-switch" id="themeSwitch" aria-label="Toggle dark mode">üåô</button>
        </div>
    </header>

    <main>
        <div class="video-grid" id="videoGrid"></div>
        <div class="loading-indicator" id="loadingIndicator">
            <div class="spinner"></div>
            <span>Loading more reels...</span>
        </div>
    </main>

    <div class="video-modal" id="videoModal">
        <div class="video-modal-content">
            <span class="close-modal" id="closeModal" aria-label="Close video viewer">&times;</span>
            <video id="modalVideo" controls></video>
        </div>
    </div>

    <div class="preload-container" id="preloadContainer"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- STATE & CONSTANTS ---
        const state = {
            currentPage: 0,
            isLoading: false,
            isDesktop: window.innerWidth > 768,
            activeMobileVideo: null,
            fullScreenVideoItem: null,
            theme: localStorage.getItem('theme') || 'light'
        };
        const config = {
            videosPerPage: 9,
            totalVideos: 49,
            baseVideoUrl: 'https://quelora.github.io/media/video'
        };

        // --- DOM ELEMENTS CACHE ---
        const elements = {
            pageHeader: document.getElementById('pageHeader'),
            videoGrid: document.getElementById('videoGrid'),
            loadingIndicator: document.getElementById('loadingIndicator'),
            videoModal: document.getElementById('videoModal'),
            modalVideo: document.getElementById('modalVideo'),
            closeModal: document.getElementById('closeModal'),
            themeSwitch: document.getElementById('themeSwitch'),
            html: document.documentElement
        };

        // --- INITIALIZATION ---
        function init() {
            setTheme(state.theme);
            setupEventListeners();
            loadVideos();
            setupIntersectionObserver();
        }

        // --- THEME ---
        function setTheme(theme) {
            state.theme = theme;
            elements.html.setAttribute('data-theme', theme);
            elements.themeSwitch.textContent = theme === 'light' ? 'üåô' : '‚òÄÔ∏è';
            localStorage.setItem('theme', theme);
        }

        function toggleTheme() {
            const newTheme = state.theme === 'light' ? 'dark' : 'light';
            setTheme(newTheme);
        }
        
        // --- EVENT LISTENERS ---
        function setupEventListeners() {
            window.addEventListener('resize', handleResize);
            window.addEventListener('scroll', handleScroll);
            elements.themeSwitch.addEventListener('click', toggleTheme);
            elements.videoGrid.addEventListener('click', handleGridClick);
            elements.closeModal.addEventListener('click', hideModal);
            elements.videoModal.addEventListener('click', (e) => {
                if (e.target === elements.videoModal) hideModal();
            });
            window.addEventListener('keydown', handleKeyboard);
        }
        
        function handleResize() {
            const wasDesktop = state.isDesktop;
            state.isDesktop = window.innerWidth > 768;
            if (wasDesktop !== state.isDesktop) {
                stopAllVideos();
                if (state.fullScreenVideoItem) {
                    exitFullVideoMode(state.fullScreenVideoItem);
                }
                setTimeout(autoplayVisibleVideo, 200);
            }
        }

        function handleScroll() {
            elements.pageHeader.classList.toggle('scrolled', window.scrollY > 10);
        }
        
        function handleKeyboard(e) {
            if (!elements.videoModal.classList.contains('active')) return;
            if (e.key === 'Escape') hideModal();
            if (e.key === ' ') {
                e.preventDefault();
                elements.modalVideo.paused ? elements.modalVideo.play() : elements.modalVideo.pause();
            }
        }

        // --- VIDEO GRID LOGIC ---
        function handleGridClick(e) {
            const videoItem = e.target.closest('.video-item');
            if (!videoItem) return;

            if (e.target.closest('.action-btn')) {
                // L√≥gica para los botones de acci√≥n (like, comment, etc.)
                // e.stopPropagation(); // Opcional: si no quieres que el video se pause/reproduzca
                return;
            }

            const action = e.target.dataset.action;
            if (action === 'exit') {
                exitFullVideoMode(videoItem);
                return;
            }
            if (e.target.closest('.sound-toggle')) {
                toggleSound(videoItem);
                return;
            }
            
            if (state.isDesktop) {
                showModal(videoItem);
            } else {
                if (videoItem.classList.contains('playing-full')) {
                    const video = videoItem.querySelector('video');
                    video.paused ? video.play() : video.pause();
                } else {
                    playFullVideoInContainer(videoItem);
                }
            }
        }

        // --- MODAL (DESKTOP) ---
        function showModal(videoItem) {
            const video = videoItem.querySelector('video');
            elements.modalVideo.src = `${config.baseVideoUrl}/${video.dataset.id}.mp4`;
            elements.videoModal.classList.add('active');
            elements.modalVideo.play().catch(() => {});
            stopAllVideos();
        }

        function hideModal() {
            elements.modalVideo.pause();
            elements.videoModal.classList.remove('active');
            setTimeout(autoplayVisibleVideo, 200);
        }

        // --- INTERSECTION OBSERVER ---
        function setupIntersectionObserver() {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.target === elements.loadingIndicator && entry.isIntersecting) {
                        loadVideos();
                        return;
                    }
                    if (entry.target.classList.contains('video-item') && !state.isDesktop) {
                        if (state.fullScreenVideoItem) {
                            if (entry.target === state.fullScreenVideoItem && entry.intersectionRatio < 0.5) {
                                exitFullVideoMode(state.fullScreenVideoItem);
                            }
                        } 
                        else {
                            const video = entry.target.querySelector('video');
                            if (entry.intersectionRatio > 0.75) {
                                if (state.activeMobileVideo !== video) {
                                    stopAllVideos();
                                    playVideo(entry.target, true);
                                    state.activeMobileVideo = video;
                                }
                            }
                        }
                    }
                });
            }, { 
                threshold: [0.5, 0.75], 
                rootMargin: '0px 0px -50px 0px' 
            });
            
            observer.observe(elements.loadingIndicator);
            return observer;
        }
        const intersectionObserver = setupIntersectionObserver();

        async function loadVideos() {
            if (state.isLoading || (state.currentPage * config.videosPerPage >= config.totalVideos)) return;
            state.isLoading = true;
            elements.loadingIndicator.style.display = 'flex';

            const fragment = document.createDocumentFragment();
            const start = state.currentPage * config.videosPerPage + 1;
            const end = Math.min(start + config.videosPerPage - 1, config.totalVideos);
            
            for (let i = start; i <= end; i++) {
                const videoItem = createVideoItem(i);
                fragment.appendChild(videoItem);
                intersectionObserver.observe(videoItem);
            }
            elements.videoGrid.appendChild(fragment);

            state.currentPage++;
            state.isLoading = false;
            if (state.currentPage * config.videosPerPage >= config.totalVideos) {
                elements.loadingIndicator.style.display = 'none';
                intersectionObserver.unobserve(elements.loadingIndicator);
            }
            setTimeout(autoplayVisibleVideo, 300);
        }
        
        function createVideoItem(id) {
            const videoItem = document.createElement('div');
            videoItem.className = 'video-item';
            videoItem.dataset.id = id;
            
            const thumbUrl = `${config.baseVideoUrl}/thumbs/${id}_thumb.mp4`;
            const posterUrl = `${config.baseVideoUrl}/posters/${id}.webp`;

            // El HTML de la barra de acciones est√° aqu√≠
            videoItem.innerHTML = `
                <img src="${posterUrl}" class="poster" alt="Video thumbnail" loading="lazy">
                <video preload="metadata" playsinline muted loop poster="${posterUrl}" data-id="${id}">
                    <source src="${thumbUrl}" type="video/mp4">
                </video>
                
                <div class="video-actions-bar">

                </div>

                <div class="play-pause-overlay">
                    <svg viewBox="0 0 24 24"><path fill="white" d="M8,5.14V19.14L19,12.14L8,5.14Z" /></svg>
                </div>
                <div class="fullscreen-controls">
                    <button class="fs-button" data-action="exit" aria-label="Exit fullscreen">‚úï</button>
                </div>
                <button class="sound-toggle" style="display: none;" aria-label="Toggle sound">üîá</button>
                <div class="video-loading"><div class="spinner"></div></div>
            `;
            
            const video = videoItem.querySelector('video');
            video.addEventListener('play', () => videoItem.classList.remove('is-paused'));
            video.addEventListener('pause', () => videoItem.classList.add('is-paused'));
            video.addEventListener('ended', () => {
                if (videoItem.classList.contains('playing-full')) exitFullVideoMode(videoItem);
            });
            return videoItem;
        }
        
        function playVideo(videoItem, isMuted) {
            const video = videoItem.querySelector('video');
            const poster = videoItem.querySelector('.poster');
            video.muted = isMuted;
            const playPromise = video.play();
            if (playPromise !== undefined) {
                playPromise.then(() => {
                    poster.style.opacity = '0';
                }).catch(() => {
                    poster.style.opacity = '1';
                });
            }
        }
        
        function stopAllVideos() {
            document.querySelectorAll('.video-item video').forEach(video => {
                video.pause();
                const poster = video.parentElement.querySelector('.poster');
                if (poster) poster.style.opacity = '1';
            });
            state.activeMobileVideo = null;
        }
        
        function autoplayVisibleVideo() {
            if (state.fullScreenVideoItem) return;

            if (state.isDesktop) {
                document.querySelectorAll('.video-item').forEach(item => {
                    item.onmouseenter = () => { if (!state.fullScreenVideoItem && !elements.videoModal.classList.contains('active')) playVideo(item, true) };
                    item.onmouseleave = () => {
                        const video = item.querySelector('video');
                        video.pause();
                        video.currentTime = 0;
                    };
                });
            } else {
                stopAllVideos();
                const videoItems = Array.from(document.querySelectorAll('.video-item'));
                let mostVisibleItem = null;
                let maxVisibility = 0;
                
                videoItems.forEach(item => {
                    const rect = item.getBoundingClientRect();
                    const viewportHeight = window.innerHeight;
                    if (rect.top >= 0 && rect.bottom <= viewportHeight) {
                        const visibleHeight = Math.min(rect.bottom, viewportHeight) - Math.max(rect.top, 0);
                        const visibilityRatio = visibleHeight / rect.height;
                        if (visibilityRatio > maxVisibility) {
                            maxVisibility = visibilityRatio;
                            mostVisibleItem = item;
                        }
                    }
                });
                
                if (mostVisibleItem) {
                    playVideo(mostVisibleItem, true);
                    state.activeMobileVideo = mostVisibleItem.querySelector('video');
                }
            }
        }

        function playFullVideoInContainer(videoItem) {
            if (state.fullScreenVideoItem) exitFullVideoMode(state.fullScreenVideoItem);
            stopAllVideos();

            const video = videoItem.querySelector('video');
            const soundToggle = videoItem.querySelector('.sound-toggle');
            const fullUrl = `${config.baseVideoUrl}/${video.dataset.id}.mp4`;

            state.fullScreenVideoItem = videoItem;
            videoItem.classList.add('playing-full', 'loading');
            soundToggle.style.display = 'flex';
            soundToggle.textContent = 'üîá';
            
            video.src = fullUrl;
            video.loop = false;
            
            video.addEventListener('loadeddata', function onLoaded() {
                videoItem.classList.remove('loading');
                video.muted = false;
                soundToggle.textContent = 'üîä';
                playVideo(videoItem, false);
                video.removeEventListener('loadeddata', onLoaded);
            }, { once: true });
            
            video.load();
        }

        function exitFullVideoMode(videoItem) {
            const video = videoItem.querySelector('video');
            const soundToggle = videoItem.querySelector('.sound-toggle');
            const thumbUrl = `${config.baseVideoUrl}/thumbs/${video.dataset.id}_thumb.mp4`;

            video.pause();
            videoItem.classList.remove('playing-full', 'loading', 'is-paused');
            soundToggle.style.display = 'none';
            state.fullScreenVideoItem = null;
            
            video.src = thumbUrl;
            video.loop = true;
            video.muted = true;
            video.load();

            setTimeout(autoplayVisibleVideo, 200);
        }

        function toggleSound(videoItem) {
            const video = videoItem.querySelector('video');
            const soundToggle = videoItem.querySelector('.sound-toggle');
            video.muted = !video.muted;
            soundToggle.textContent = video.muted ? 'üîá' : 'üîä';
        }

        // --- START THE APP ---
        init();
    });
    </script>
    <script type="module" src="./js/quelora.kitty.conf.js"></script> 
    <script type="module" src="./quelora/js/quelora.js"></script> 
</body>
</html>